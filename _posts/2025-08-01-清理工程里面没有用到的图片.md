---
layout:     post
title:      Swift 清理工程图片
subtitle:   
date:       2025-08-01
author:     夏天无泪
header-img: img/post-bg-digital-native.jpg?raw=true
catalog: true
tags:
    - 学习记录
---


# 清理工程图片

### 放到目录下

##### CD 到工程目录下 touch image_scanner.rb  然后粘贴一运行就OK 了
```
#!/usr/bin/env ruby

# 配置：修改这些路径以匹配你的项目
PROJECT_DIR = "."  # 项目根目录
RESOURCE_EXTENSIONS = %w[imageset jpg png gif pdf]  # 图片资源扩展名
SOURCE_EXTENSIONS = %w[swift h m mm xib storyboard]  # 代码和界面文件扩展名
EXCLUDE_DIRS = %w[Pods Carthage Vendor]  # 排除的目录

# 收集所有图片资源（合并同名称不同分辨率版本）
def collect_resources
  resources = {}
  RESOURCE_EXTENSIONS.each do |ext|
    Dir.glob(File.join(PROJECT_DIR, "**", "*.#{ext}")).each do |path|
      # 跳过排除目录
      next if EXCLUDE_DIRS.any? { |dir| path_include_dir?(path, dir) }
      
      # 提取资源名（去掉扩展名、@2x/@3x后缀和路径）
      base_name = File.basename(path, ".*")
      normalized_name = base_name.gsub(/@\d+x$/, '')  # 移除分辨率标识
      
      # 只保留一个路径作为代表
      resources[normalized_name] = path unless resources.key?(normalized_name)
    end
  end
  resources
end

# 扫描代码和界面文件中所有图片引用
def scan_references(resources)
  references = Set.new
  # 提取所有资源名称，用于精准匹配
  resource_names = resources.keys
  
  SOURCE_EXTENSIONS.each do |ext|
    Dir.glob(File.join(PROJECT_DIR, "**", "*.#{ext}")).each do |file|
      # 跳过排除目录
      next if EXCLUDE_DIRS.any? { |dir| path_include_dir?(file, dir) }
      
      content = File.read(file)
      
      if ext == "xib" || ext == "storyboard"
        # XIB和Storyboard中的图片引用处理
        content.scan(/image(?:Name)?="([^"]+)"/) do |match|
          add_reference(references, match[0])
        end
        
        content.scan(/<imageReference>([^<]+)<\/imageReference>/) do |match|
          add_reference(references, match[0])
        end
        
        content.scan(/<userDefinedRuntimeAttributes.*?value="([^"]+)".*?keyPath="image"/m) do |match|
          add_reference(references, match[0])
        end
        
        content.scan(/<imageView.*?image="([^"]+)"/m) do |match|
          add_reference(references, match[0])
        end
        
        content.scan(/background(?:Image)?="([^"]+)"/) do |match|
          add_reference(references, match[0])
        end
        
        content.scan(/<state key="normal" backgroundImage="([^"]+)"/) do |match|
          add_reference(references, match[0])
        end
        content.scan(/keyPath="backgroundImage" value="([^"]+)"/) do |match|
          add_reference(references, match[0])
        end
        
      else
        # 代码文件处理
        
        # 1. 恢复对R.image引用的正确识别
        content.scan(/R\.image\.([a-zA-Z0-9_]+)\(\s*.*?\s*\)?[!?]?(?:\.\w+)*?/) do |match|
          references.add(match[0])
        end
        
        # 2. UIImage(named:)引用
        content.scan(/UIImage\(named:\s*"([^"]+)"/) do |match|
          add_reference(references, match[0])
        end
        
        # 3. 变量赋值的图片引用（如xxx.image = "name"）
        content.scan(/(image|Image|imageName|ImageName)\s*=\s*"([^"]+)"/) do |match|
          add_reference(references, match[1])
        end
        
        # 4. 通用字符串匹配：匹配所有双引号中的图片名称
        # 只匹配确实存在的资源名，避免误匹配普通字符串
        content.scan(/"([^"]+)"/) do |match|
          img_name = match[0]
          # 只有当这个字符串是我们已知的资源名时，才认为是引用
          if resource_names.include?(img_name)
            add_reference(references, img_name)
          end
        end
      end
    end
  end
  references
end

# 辅助方法：检查路径是否包含指定目录
def path_include_dir?(path, dir)
  File.expand_path(path).include?(File.expand_path(File.join(PROJECT_DIR, dir)))
end

# 辅助方法：添加引用（过滤空字符串）
def add_reference(references, name)
  references.add(name) unless name.nil? || name.strip.empty?
end

# 主程序
resources = collect_resources
references = scan_references(resources)

# 找出未被引用的资源
unused = resources.select { |name, _| !references.include?(name) }

# 输出结果
puts "找到 #{unused.size} 个未使用的图片资源："
unused.each do |name, path|
  puts "  - #{name} (#{path})"
end
    

```

筛选结果演示

![](https://18501393475-1302810375.cos.ap-beijing.myqcloud.com/2025/08/01/17540162488829.jpg)
