---
layout:     post
title:      UI界面的卡顿优化
subtitle:   
date:       2019-12-25
author:     夏天无泪
header-img: img/post-bg-keybord.jpg
catalog: true
tags:
    - 学习整理
---

# UI界面的卡顿及优化

从上述结论中可以得出，造成卡顿的原因是由CPU和GPU造成的，所有优化的时候也要从这两个方面来着手。那么解决卡顿的主要思路就是尽可能减少CPU、GPU资源消耗，按照60FPS的刷新帧率，每隔16ms就会有一次VSync信号。  


## 一、UITableView的优化  

1. 正确使用reuseIdentifier重用机制。如UITableViewCells、UICollectionViewCells、UITableViewHeaderFooterViews设置正确的reuseIdentifier，充分重用，但会有重叠问题，重叠问题的解决方法是在判断cell为空的里面对label进行初始化，保证每个cell里只有一个label。  
2. 在height和cellFor这两个方法里面分析。赋值和计算布局分离。可以在网络请求成功之后立即开始高度等布局的计算。异步后台绘制。对于cell的行高要缓存起来，使得reload数据时，效率也极高。而对于那些网络数据，不需要每次都请求的，应该缓存起来，可以写入数据库，也可以通过plist文件存储。
3. 滑动时。滑动tableView时，按需加载对应的内容，滑动停止再加载当前屏幕的cell。Runloop中让加载图片处于defaultMode而不是trackingMode，保证滑动的流畅性。按需加载，滑动时不加载，当停止时加载当前页面的数据
4. 透明度。设定背景颜色，尽量少用和不用透明图层。当opque为NO的时候，图层的半透明取决于图片和其本身合成的图层为结果，可提高性能。
5. 尽量少用AutoLayout。如果视图较少，可以采用left/right/top/bottom/width/height 快捷属性。
6. 图片载入。后台解码，加载图片，主线程显示。多用CALayer，少用UIView。
7. 延迟加载。对于不应该使用的数据，使用延迟加载方式。对于不需要马上显示的视图，使用延迟加载方式。比如，网络请求失败时显示的提示界面，可能一直都不会使用到，因此应该使用延迟加载。
8. 尽量避免渐变、图片拉伸与离屏渲染
9. 减少子视图的层级关系
10. 异步请求加载 Cell 展示数据，并进行预处理，包括图片的加载、压缩，富文本的显示
11. 尽量避免渐变、图片拉伸与离屏渲染
12. 尽量减少不必要的透明视图
13. 设置统一规格的 Cell

预加载与延迟加载
* 预处理：耗时操作提前在后台线程进行处理
* 延迟加载：必要可视内容优先加载，其他内容稍后或需要展示时再加载

合理进行线程分配  
合理的线程分配，最终目的就是保证主线程尽量少地处理非 UI 操作，同时将整个 App 中子线程数量控制在合理范围，以避免不必要子线程开启与切换消耗。  
* UI 与数据源操作在主线程
* 数据库操作、日志记录、网络回调在相应的固定线程
* 不同业务，通过创建队列保证数据一致性


## 二、界面优化的第三方库  
### AsyncDisplayKit  

AsyncDisplayKit 是一个UI框架，最初诞生于 Facebook 的 Paper 应用程序。它是为了解决 Paper 团队面临的核心问题之一：尽可能缓解主线程的压力。它能在异步线程绘制修改UI，然后统一添加进内存渲染出来。


AsyncDisplayKit， 它对 iOS 的 UI 响应做了进一步优化。 其中一个特点就是允许在非主线程操作 UI 控件。 是的，你没看错。 必须在主线程操作 UI 控件这个概念几乎成了 iOS 以及大多数客户端开发的定律。如果在 iOS 中的非主线程操作 UI， 就会导致一系列奇怪的结果，甚至造成应用 Crash。  
 不过，AsyncDisplayKit 确实能够提供这个能力。 这样你就可以让主线程更加有效率。 比如，你可以将 UIImage 加载图片的操作放到异步线程中， 并且在这个异步线程中设置图片， 调整 UI 组件的 frame 等等。 不支持大家常用的storyboard、xib、autoLayout，影响开发效率，但是可以和UIKit混合开发。
 
感兴趣的同学可以看看[AsyncDisplayKit的使用](https://www.jianshu.com/p/68f6d24d0b2e)
